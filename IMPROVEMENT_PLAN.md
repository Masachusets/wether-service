## План улучшений (отмечайте выполненное)

Инструкция: ставьте галочки в чекбоксах по мере выполнения. Не меняйте формулировки задач, добавляйте новые пункты снизу соответствующего раздела.

### 0. Быстрые точечные улучшения
- [ ] Вынести формат времени и повторяющиеся SQL в константы
- [ ] Уточнить уровни логов и сообщения об ошибках
- [ ] Привести имена переменных к единообразию (`dbConnString`, `httpAddr`)
- [ ] Добавить middleware `Timeout` на HTTP-слой

### 1. Архитектура и структура пакетов
- [ ] Разделить слои: `cmd/server`, `internal/app`, `internal/httpapi`, `internal/service`, `internal/repository`, `internal/clients`, `internal/scheduler`
- [ ] Ввести интерфейсы: `GeocodingClient`, `MeteoClient`, `ReadingRepository`
- [ ] Разнести модели: доменные (`Reading`) отдельно от DTO клиентов и от SQL-моделей

### 2. Конфигурация
- [ ] Вынести `httpPort`, `city`, `db_conn`, интервалы задач и таймауты в `internal/config`
- [ ] Загрузка конфига из env/файла (`envconfig`/`viper`)
- [ ] Профили окружений: dev/test/prod значения по умолчанию

### 3. Работа с БД
- [ ] Заменить `pgx.Conn` на пул `pgxpool.Pool`
- [ ] Добавить инструмент миграций (`golang-migrate`/`goose`) и каталог `migrations`
- [ ] Репозиторий: `GetLatestByCity(ctx, city)` и `Insert(ctx, reading)`
- [ ] Индекс и уникальность на `(name, timestamp)` + `UPSERT` для идемпотентности
- [ ] Оборачивать запросы БД в `context.WithTimeout`

### 4. HTTP-слой
- [ ] Грейсфул шатдаун: обработка OS-сигналов, корректное завершение сервера и планировщика
- [ ] Middlewares: request ID, recoverer, timeout, CORS (по необходимости)
- [ ] Единый формат ответов/ошибок JSON, заголовок `Content-Type`
- [ ] Эндпоинты `/healthz`, `/readyz`, `/metrics` (Prometheus)

### 5. Планировщик
- [ ] Управление жизненным циклом через контекст (start/stop, ожидание завершения)
- [ ] Интервал и расписание из конфига (поддержка cron-спецификации при необходимости)
- [ ] Защита от перекрытий запусков (in-memory mutex или advisory lock в БД)
- [ ] Ретраи с экспоненциальной паузой на внешних вызовах

### 6. Клиенты внешних API
- [ ] Интерфейсы и внедрение зависимостей для тестируемости
- [ ] Таймауты и `context` на уровне запроса; общий настраиваемый `http.Transport`
- [ ] Ретраи/бэк-офф для 5xx/сетевых ошибок; ограничение числа попыток
- [ ] Логирование ключевых полей запроса/ответа (без чувствительных данных)
- [ ] Кэширование координат города (TTL)

### 7. Логирование и наблюдаемость
- [ ] Структурированное логирование (`zap`/`zerolog`)
- [ ] Корреляция: request ID/span ID в логах HTTP, БД, планировщика
- [ ] Метрики: latency/успех/ошибка по HTTP, БД, клиентам, задачам

### 8. Время и часовые зоны
- [ ] Единая зона хранения — UTC; централизованные конвертации
- [ ] Формат времени вынести в константу; валидация входных значений

### 9. Валидация и ошибки
- [ ] Доменные ошибки (`ErrNotFound`, `ErrConflict`) и маппинг на HTTP статусы
- [ ] Валидация входов (например, `city`) в хендлере
- [ ] Использовать `errors.Is`/`errors.As` вместо сравнения строк

### 10. Тестирование
- [ ] Юнит-тесты: table-driven для хендлеров, сервисов, клиентов (через интерфейсы)
- [ ] Интеграционные тесты с PostgreSQL (`testcontainers`/`docker-compose`)
- [ ] Контрактные тесты внешних API (через `httptest.Server`)
- [ ] E2E smoke: старт сервера и один запрос

### 11. CI/CD и качество
- [ ] Настроить `golangci-lint`, `gofumpt`, `staticcheck`, `ineffassign`
- [ ] Makefile/Taskfile: `build`, `test`, `lint`, `run`, `migrate`
- [ ] Dockerfile (многослойный), `docker-compose` для dev (app+db)
- [ ] Процесс релизов: версионирование и ченджлог

### 12. DX и документация
- [ ] Обновить `README`: запуск локально/в докере, переменные окружения, миграции
- [ ] Примеры запросов (curl/httpie), схема ответов и ошибок
- [ ] Небольшая диаграмма модулей/потока данных

---

Последнее обновление: заполните дату при изменениях.


